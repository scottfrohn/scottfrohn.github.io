---
title: "ManagingManyModels"
author: "Scott Frohn"
date: "`r Sys.Date()`"
output: html_document
---

# Introduction
This project is based on Hadley Wickham's talk "[Managing many models with R](https://www.youtube.com/watch?v=rz3_FDVt9eg)", and covers Chapter 25 "[Many Models](https://r4ds.had.co.nz/many-models.html)" from R for Data Science 


# Wrangle

Load packages
```{r include=FALSE}
library(gapminder)   # Our dataset: demographic information by country by year
library(modelr)      # Facilitates modeling
library(tidyverse)   # Keeps things tidy
library(ggthemes)    # for theme_clean()
```

Read in data
```{r}
gapminder <- gapminder %>% mutate(year1950 = year - 1950)
gapminder %>% head
```


## Nest Data
```{r}
by_country <- gapminder %>%
  group_by(continent, country) %>%
  nest

by_country$data[[1]]
```

Now we have a dataframe including one variable (`data`) as a list of data frames. Above is the dataframe contained for the first entry of our higher-level dataframe (Afghanistan). 


# Model
Now we can run a simple linear model (`lm()`) for every country in our dataframe, given the country-specific dataframe held with the `data` list. To do this we'll use the `purrr::map` function to apply a function to each element of a vector

```{r}
# Create the function to predict life expectancy from the year (after 1950)
country_model <- function(df) {
  lm(lifeExp ~ year1950, data = df)
}

# And run that function across our dataframe (using Functional Programming)
models <- by_country %>%
  mutate(model = map(data, country_model))
```

Now we have a list of linear models. 

- Q. So what can we do with them? 
- A. Turn them into tidy data.

Let's create new variables, which will be lists of different information from our linear models. We'll also create a vector variable `rsq` to capture the r-squared for each model.
```{r}
models <- models %>%
  mutate(tidy    = map(model, broom::tidy),    # Model fit
         glance  = map(model, broom::glance),  # Model coefficients
         augment = map(model, broom::augment), # Residuals
         rsq = glance %>% map_dbl("r.squared"))

models
```

Now that we have all of the information we need, we can start to unnest the data to make them more useful for plotting and other types of analysis.
```{r}
unnest(models, data)
unnest(models, glance)
unnest(models, tidy)
```

# Visualize
Note that unnesting "tidy" results in a single column for the "term" and an estimate from our linear model. Not terribly useful for plotting, so we'll have to use `spread()` to put into a better format.

```{r}
models %>%
  unnest(tidy) %>%
  select(continent, country, term, estimate, rsq) %>%
  spread(term, estimate) %>%
  ggplot(aes(x = `(Intercept)`, y = year1950)) +
    geom_point(aes(color = continent, size = rsq), alpha = 0.5) +
    geom_smooth(se = FALSE, color = "black") +
    labs(x = "Life Expectancy (1950)",
         y = "Yearly Improvement") +
    scale_size_area() +
    theme_clean()
```
This plot depicts the linear model intercept (x-axis) against the slope (y-axis) for every country, by continent and effect size. 
